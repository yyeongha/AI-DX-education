# yolov5 학습
* 커스텀 모델 (custom model)
=> 데이터 수집 -> 데이터분류 -> dataset -> 전처리 -> 학습 -> pre-trained
=> 서비스 구축

* pre-trained 모델을 사용한다.
=> pre-trained 서비스 구축
- 인공지능을 구현하는 부분보다는 sota(status of the art) 서비스 구축


# 커스텀 모델 구축
* 알파벳 학습
engsign.zip
- 구글드라이브에 압축을 풀어서 업로드 (나는 여기서 이거 선택!)
- 압축파일을 올려서 압축을 해제 

* 코랩 + 구글드라이브

* 노트명 : yolov5_sign

## 학습 결과
```
# 학습진행
! python train.py --img 415 --batch 16 --epochs 50 --data /content/drive/MyDrive/AI-DX-education/datasets/data.yaml --cfg ./models/yolov5s.yaml --weights yolov5s.pt --name sign_yolov5s_results
```
![학습결과]()

-> 결과를 보면 i가 학습률이 낮은 것을 알 수 있다. 


### last.pt, best.pt
/content/drive/MyDrive/AI-DX-education/datasets/sign/sign_yolov5s_results/weights

이 경로에 있는 last.pt, best.pt 중 어떤 것을 써야할까? 정답은 둘 다 써야한다.

지금처럼 일부 성능이 안좋으면 학습을 더 시켜야하고 성능을 더 끌어오르는지 봐야한다.

이 경우는 이미지를 증가시킬때 image generator를 쓰면 안된다. 왜냐하면 이 이미지는 정면의 수화를 인식하는건데, 수화의 형태가 정해져있기 때문에 수화가 돌아가거나 변하면 다른 언어로 인식할 수 있기 때문이다. 


### confusion nmatrix
confusion matrix에서 대각선이 1이 나오면 100% 정확한것이다. 

![confusionmatrix]()

-> 내 confusion matrix를 보면 거의 못맞춘다는 것을 알 수 있다.

### F1 curve
뚝뚝 떨어지는 그래프는 검출이 안된다는 것이다.

### labels
데이터는 고르게 들어와서 데이터의 문제는 아니지만, 수화 자체가 쉽지 않았기 때문에 인식을 못한것으로 보임

### P curve, PR curve, R curve
파란색 그래프에 밀접하게 학습이 안되었다.

![P_curve]()
![PR_curve]()
![R_curve]()

### results
![results]()

### 실제 인식한 이미지
![train_batch0]()
![train_batch1]()
![train_batch2]()

### result.csv 
평가에 대한 보고서

## 내 컴퓨터 파일
D:\dev\github\AI-DX-education\ai_exam\yolov5_test\runs\
이 경로에 
train 폴더 생성 -> colab에 sign_yolov5s_results 폴더에 있는 모든 파일을 train폴더에 옮기기


## custom model 동작
* vscode 에서
D:\dev\github\AI-DX-education\ai_exam\yolov5_test 
폴더 열기

* 가상환경 : p312_yolov5

## 영어 수화 손동작을 인식하는지 확인
* 터미널에서
```
python detect.py --weights ./runs/train/sign_yolov5s_results/weights/best.pt --conf 0.5 --source https://www.youtube.com/watch?v=1rD4w_QvtiE&t=1s 
```

```
Traceback (most recent call last):
  File "D:\dev\github\AI-DX-education\ai_exam\yolov5_test\detect.py", line 312, in <module>
    main(opt)
  File "D:\dev\github\AI-DX-education\ai_exam\yolov5_test\detect.py", line 307, in main  
    run(**vars(opt))
  File "C:\Users\user\anaconda3\envs\p312_yolov5\Lib\site-packages\torch\utils\_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\dev\github\AI-DX-education\ai_exam\yolov5_test\detect.py", line 115, in run   
    model = DetectMultiBackend(weights, device=device, dnn=dnn, data=data, fp16=half)    
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^    
  File "D:\dev\github\AI-DX-education\ai_exam\yolov5_test\models\common.py", line 467, in __init__
    model = attempt_load(weights if isinstance(weights, list) else w, device=device, inplace=True, fuse=fuse)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\dev\github\AI-DX-education\ai_exam\yolov5_test\models\experimental.py", line 98, in attempt_load
    ckpt = torch.load(attempt_download(w), map_location="cpu")  # load
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\user\anaconda3\envs\p312_yolov5\Lib\site-packages\torch\serialization.py", line 1025, in load
    return _load(opened_zipfile,
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\user\anaconda3\envs\p312_yolov5\Lib\site-packages\torch\serialization.py", line 1446, in _load
    result = unpickler.load()
             ^^^^^^^^^^^^^^^^
  File "C:\Users\user\anaconda3\envs\p312_yolov5\Lib\pathlib.py", line 1422, in __new__  
    raise NotImplementedError(
NotImplementedError: cannot instantiate 'PosixPath' on your system
't'은(는) 내부 또는 외부 명령, 실행할 수 있는 프로그램, 또는
배치 파일이 아닙니다.
```
-> 오류 발생..

### 오류 해결
detect.py 파일 위에 밑의 코드를 추가해서 실행하면 해결됨

```
import pathlib
temp = pathlib.PosixPath
pathlib.PosixPath = pathlib.WindowsPath
```

## 실행결과
![실행결과]()

실행이 되지만 손 인식과 정확한 알파벳 수화 인식이 안된다.
-> 200번 학습을 시키는 것으로 변경함


## 200번 학습 시키기
colab yolov5_sign 파일
원래 코드에서 
* batch 없애기
* epochs : 200
으로 변경해서 다시 실행

```
# 학습진행
! python train.py --img 415 --epochs 200 --data /content/drive/MyDrive/AI-DX-education/datasets/data.yaml --cfg ./models/yolov5s.yaml --weights yolov5s.pt --name /content/drive/MyDrive/AI-DX-education/datasets/sign/sign_results/
```

## 다시 실행
* python 터미널에서
```
python detect.py --weights ./runs/train/sign_yolov5s_results/weights/best.pt --conf 0.5 --source https://www.youtube.com/watch?v=1rD4w_QvtiE&t=1s 
```

## 
yolov5_program/train 에 
last.pt, 

## yolov5_program 폴더 열고
yolov5_sign.py 생성후
```
pip install yolov5
```

## 
```yolov5_sign.py
# 라이브러리 불러오기
import cv2
import torch
import yolov5
import pandas as pd
import yaml
import time

# yolov5 custom model 불러오기
model = torch.hub.load(
    'ultralytics/yolov5', 
    'custom', 
    path='./train/best.pt', 
    force_reload=True
    )
```
-> 에러가 뜬다.
![]()


### 에러 해결
yolov5_sign.py 위에 이 코드를 추가하면 해결된다. 
```
import pathlib
temp = pathlib.PosixPath
pathlib.PosixPath = pathlib.WindowsPath
```

## 
```
# 라이브러리 불러오기
import cv2
import torch
import yolov5
import pandas as pd
import yaml
import time

import pathlib
temp = pathlib.PosixPath
pathlib.PosixPath = pathlib.WindowsPath

# yolov5 custom model 불러오기
model = torch.hub.load(
    'ultralytics/yolov5', 
    'custom', 
    path='./train/best.pt', 
    force_reload=True
    )

# yaml에 있는 데이터셋(labels) 불러오기
data_yaml = './train/data.yaml'

with open(data_yaml) as f:
    data = yaml.load(f, Loader=yaml.FullLoader)

print(data)
print(data['names'])
```
이 코드를 실행하면 밑의 사진처럼 실행됨

![loaddataset]()

## 


![]()
![]()
![]()
![]()
![]()
![]()
![]()
![]()
